name: Update demo recording

on:
  push:
    branches: [main]
    paths:
      - "frontend/src/**"
      - "demo/**"
      - ".github/workflows/update-demo.yml"

permissions:
  contents: write

jobs:
  record:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: cd frontend && npm ci && npm run build

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Copy frontend to web/dist
        run: rm -rf web/dist && cp -r frontend/dist web/dist

      - name: Build binary
        run: go build -o flagd-ui ./cmd/flagd-ui

      - name: Install recording dependencies
        run: cd demo/recording && npm ci && npx playwright install --with-deps chromium

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Record demo
        run: |
          ./flagd-ui -flag-dir ./demo -addr :9090 &
          sleep 2
          node demo/recording/record.mjs
          kill %1 2>/dev/null || true

      - name: Commit updated recording
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add demo/recording/flagd-ui-demo.mp4
          if git diff --cached --quiet; then
            echo "No changes to recording"
          else
            git commit -m "Update demo recording [skip ci]"
            git push
          fi
